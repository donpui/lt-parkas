<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LT Transporto Priemonių Analizė</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; padding: 20px; }
  h1 { text-align: center; margin-bottom: 20px; font-size: 1.4rem; }
  .loading { text-align: center; padding: 60px 20px; }
  .loading .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: #2563eb; border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .progress-wrap { display: none; width: 260px; margin: 12px auto 0; background: #eee; border-radius: 4px; height: 8px; overflow: hidden; }
  .progress-bar { height: 100%; width: 0%; background: #2563eb; border-radius: 4px; transition: width 0.2s; }
  .progress-text { font-size: 0.8rem; color: #999; margin-top: 6px; }
  .app { display: none; }
  .filters { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; background: #fff; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  .filter-group { flex: 1; min-width: 180px; }
  .filter-group label { display: block; font-size: 0.75rem; font-weight: 600; margin-bottom: 4px; color: #666; text-transform: uppercase; }
  .combo { position: relative; }
  .combo input { width: 100%; padding: 8px; padding-right: 28px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: #fff; }
  .combo input:focus { outline: none; border-color: #2563eb; }
  .combo .clear-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #999; font-size: 1.1rem; line-height: 1; padding: 0 2px; display: none; }
  .combo .clear-btn:hover { color: #333; }
  .combo.has-value .clear-btn { display: block; }
  .combo .dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 240px; overflow-y: auto; background: #fff; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; z-index: 100; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  .combo.open .dropdown { display: block; }
  .combo .dropdown .opt { padding: 6px 10px; cursor: pointer; font-size: 0.85rem; }
  .combo .dropdown .opt:hover, .combo .dropdown .opt.active { background: #e9ecef; }
  .combo .dropdown .opt.selected { font-weight: 600; color: #2563eb; }
  .combo .dropdown .no-match { padding: 8px 10px; color: #999; font-size: 0.85rem; }
  .num-filter { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; background: #fff; }
  .num-filter:focus { outline: none; border-color: #2563eb; }
  .filter-actions { display: flex; gap: 16px; margin: -8px 0 12px 0; }
  .more-toggle { display: inline-block; font-size: 0.85rem; color: #2563eb; cursor: pointer; user-select: none; }
  .clear-filters { display: inline-block; font-size: 0.85rem; color: #dc2626; cursor: pointer; user-select: none; }
  .more-toggle:hover { text-decoration: underline; }
  .extra-filters { display: none; }
  .extra-filters.open { display: flex; }
  .info-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.85rem; color: #666; }
  .table-wrap { overflow-x: auto; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  th { background: #f8f9fa; position: sticky; top: 0; padding: 10px 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-size: 0.75rem; text-transform: uppercase; color: #666; white-space: nowrap; cursor: pointer; user-select: none; }
  th:hover { color: #333; }
  th .sort-arrow { color: #2563eb; margin-left: 3px; }
  td { padding: 8px 12px; border-bottom: 1px solid #eee; white-space: nowrap; }
  tr:hover td { background: #f8f9fa; }
  .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 12px; }
  .pagination button { padding: 6px 14px; border: 1px solid #ddd; border-radius: 4px; background: #fff; cursor: pointer; font-size: 0.85rem; }
  .pagination button:disabled { opacity: 0.4; cursor: default; }
  .pagination button:not(:disabled):hover { background: #e9ecef; }
  .pagination span { font-size: 0.85rem; color: #666; }
  .querying .table-wrap, .querying .pagination { opacity: 0.5; }
  .mini-spinner { display: none; width: 14px; height: 14px; border: 2px solid #ddd; border-top-color: #2563eb; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; margin-left: 6px; }
  .querying .mini-spinner { display: inline-block; }
  tbody tr { cursor: pointer; }
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; justify-content: center; align-items: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: #fff; border-radius: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); max-width: 700px; width: 90%; max-height: 85vh; display: flex; flex-direction: column; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #eee; }
  .modal-header h2 { font-size: 1rem; }
  .modal-close { background: none; border: none; font-size: 1.4rem; cursor: pointer; color: #999; padding: 0 4px; }
  .modal-close:hover { color: #333; }
  .modal-body { overflow-y: auto; padding: 0; }
  .detail-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  .detail-table tr:hover { background: #f8f9fa; }
  .detail-table th { text-align: left; padding: 6px 16px; color: #666; font-size: 0.75rem; text-transform: uppercase; white-space: nowrap; width: 40%; background: #fafafa; border-bottom: 1px solid #eee; }
  .detail-table td { padding: 6px 16px; border-bottom: 1px solid #eee; word-break: break-word; }
</style>
</head>
<body>

<h1>LT Transporto Priemonių Parko Duomenys</h1>

<div id="loading" class="loading">
  <div class="spinner"></div>
  <div id="loading-text">Kraunama DuckDB...</div>
  <div class="progress-wrap" id="progress-wrap"><div class="progress-bar" id="progress-bar"></div></div>
  <div class="progress-text" id="progress-text"></div>
</div>

<div id="app" class="app">
  <div class="filters">
    <div class="filter-group">
      <label>Markė</label>
      <div class="combo" id="f-marke"><input type="text" placeholder="Visos"><button class="clear-btn">&times;</button><div class="dropdown"></div></div>
    </div>
    <div class="filter-group">
      <label>Komercinis pav.</label>
      <div class="combo" id="f-komercinis"><input type="text" placeholder="Visi (Shift+click = multi)"><button class="clear-btn">&times;</button><div class="dropdown"></div></div>
    </div>
    <div class="filter-group">
      <label>Kategorija</label>
      <div class="combo" id="f-kategorija"><input type="text" placeholder="Visos"><button class="clear-btn">&times;</button><div class="dropdown"></div></div>
    </div>
    <div class="filter-group">
      <label>Modelio metai</label>
      <div class="combo" id="f-metai"><input type="text" placeholder="Visi"><button class="clear-btn">&times;</button><div class="dropdown"></div></div>
    </div>
  </div>

  <div class="filter-actions">
    <a class="more-toggle" id="more-toggle">Daugiau filtrų &#9662;</a>
    <a class="clear-filters" id="clear-filters">Išvalyti filtrus</a>
  </div>

  <div class="filters extra-filters" id="extra-filters">
    <div class="filter-group">
      <label>Darbinis tūris (cm³)</label>
      <input type="text" class="num-filter" id="f-turis" placeholder="pvz.: 1968, >=1500, <3000">
    </div>
    <div class="filter-group">
      <label>Galia (kW)</label>
      <input type="text" class="num-filter" id="f-galia" placeholder="pvz.: 110, >=75, <200">
    </div>
    <div class="filter-group">
      <label>Rida</label>
      <input type="text" class="num-filter" id="f-rida" placeholder="pvz.: <=100000, >50000">
    </div>
    <div class="filter-group">
      <label>Maks. greitis</label>
      <input type="text" class="num-filter" id="f-greitis" placeholder="pvz.: 200, >=180">
    </div>
    <div class="filter-group">
      <label>Savivaldybė</label>
      <div class="combo" id="f-savivaldybe"><input type="text" placeholder="Visos"><button class="clear-btn">&times;</button><div class="dropdown"></div></div>
    </div>
  </div>

  <div class="info-bar">
    <span><span id="count">-</span><span class="mini-spinner"></span></span>
    <span id="query-time"></span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr id="thead-row">
          <th data-col="AGR_MARKE">Markė</th>
          <th data-col="KOMERCINIS_PAV">Komercinis pav.</th>
          <th data-col="GAMINTOJO_PAV">Gamintojo pav.</th>
          <th data-col="GAMINTOJO_PAV_BAZ">Gam. pav. baz.</th>
          <th data-col="KATEGORIJA_KLASE">Kategorija</th>
          <th data-col="KEB_PAVADINIMAS">Kėbulas</th>
          <th data-col="DEGALAI">Degalai</th>
          <th data-col="GALIA">Galia (kW)</th>
          <th data-col="DARBINIS_TURIS">Tūris (cm³)</th>
          <th data-col="AGR_CAR_YEAR">Modelio metai</th>
          <th data-col="PIRM_REG_DATA">Pirma reg.</th>
          <th data-col="RIDA">Rida</th>
          <th data-col="SPALVA">Spalva</th>
          <th data-col="SAVIVALDYBE">Savivaldybė</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="pagination">
    <button id="btn-prev" disabled>&larr; Ankstesnis</button>
    <span id="page-info">-</span>
    <button id="btn-next" disabled>Kitas &rarr;</button>
  </div>
</div>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modal-title">Informacija</h2>
      <button class="modal-close" id="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <table class="detail-table"><tbody id="modal-body"></tbody></table>
    </div>
  </div>
</div>

<script type="module">
  import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.29.0/+esm';

  const PAGE_SIZE = 50;
  let db, conn;
  let currentPage = 0;
  let totalRows = 0;
  let allColumns = [];
  let lastResultRows = [];
  let sortCol = null;
  let sortDir = 'ASC';

  const FILTERS = [
    { id: 'f-marke', col: 'AGR_MARKE' },
    { id: 'f-komercinis', col: 'KOMERCINIS_PAV' },
    { id: 'f-kategorija', col: 'KATEGORIJA_KLASE' },
    { id: 'f-metai', col: 'AGR_CAR_YEAR' },
  ];

  const NUMERIC_FILTERS = [
    { id: 'f-turis', col: 'DARBINIS_TURIS' },
    { id: 'f-galia', col: 'GALIA' },
    { id: 'f-rida', col: 'RIDA' },
    { id: 'f-greitis', col: 'MAKS_GREITIS' },
  ];

  const EXTRA_COMBO_FILTERS = [
    { id: 'f-savivaldybe', col: 'SAVIVALDYBE' },
  ];

  const ALL_COMBO_FILTERS = [...FILTERS, ...EXTRA_COMBO_FILTERS];

  // Each combo filter stores its full option list and selected values (array)
  const filterState = {};
  for (const f of ALL_COMBO_FILTERS) {
    filterState[f.id] = { allOptions: [], selectedValues: [] };
  }

  const DISPLAY_COLS = [
    'AGR_MARKE', 'KOMERCINIS_PAV', 'GAMINTOJO_PAV', 'GAMINTOJO_PAV_BAZ',
    'KATEGORIJA_KLASE', 'KEB_PAVADINIMAS', 'DEGALAI', 'GALIA',
    'DARBINIS_TURIS', 'AGR_CAR_YEAR', 'PIRM_REG_DATA', 'RIDA',
    'SPALVA', 'SAVIVALDYBE'
  ];

  const $ = (s) => document.querySelector(s);

  // --- Combo box (click = single select, Shift+click = add to selection) ---
  function setupCombo(comboEl, filterId) {
    const input = comboEl.querySelector('input');
    const dropdown = comboEl.querySelector('.dropdown');
    const clearBtn = comboEl.querySelector('.clear-btn');
    let activeIdx = -1;
    let preventBlur = false;

    function getSelected() { return filterState[filterId].selectedValues; }
    function setSelected(arr) { filterState[filterId].selectedValues = [...arr]; }

    function displayValue() {
      const sel = getSelected();
      if (sel.length === 0) return '';
      if (sel.length === 1) return sel[0];
      return sel[0] + ' +' + (sel.length - 1);
    }

    function renderDropdown() {
      const search = input.value.toLowerCase();
      const opts = filterState[filterId].allOptions;
      const sel = getSelected();
      const filtered = opts.filter(o => o.toLowerCase().includes(search));

      dropdown.innerHTML = '';
      activeIdx = -1;

      if (filtered.length === 0) {
        dropdown.innerHTML = '<div class="no-match">Nieko nerasta</div>';
        return;
      }

      for (const val of filtered) {
        const div = document.createElement('div');
        div.className = 'opt' + (sel.includes(val) ? ' selected' : '');
        div.textContent = val;
        div.addEventListener('mousedown', (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (e.shiftKey) preventBlur = true;
          selectOption(val, e.shiftKey);
          if (e.shiftKey) {
            // Re-focus input after DOM rebuild
            requestAnimationFrame(() => { input.focus(); preventBlur = false; });
          }
        });
        dropdown.appendChild(div);
      }
    }

    let shiftTimer = null;

    function selectOption(val, addToSelection) {
      const sel = getSelected();
      if (addToSelection) {
        // Shift+click: toggle in multi-selection
        if (sel.includes(val)) {
          setSelected(sel.filter(v => v !== val));
        } else {
          setSelected([...sel, val]);
        }
        comboEl.classList.toggle('has-value', getSelected().length > 0);
        // Re-render dropdown without closing, debounce the query
        renderDropdown();
        clearTimeout(shiftTimer);
        shiftTimer = setTimeout(async () => {
          currentPage = 0;
          await queryCount();
          await queryResults();
        }, 400);
      } else {
        // Normal click: single select, close
        setSelected([val]);
        input.value = displayValue();
        comboEl.classList.toggle('has-value', true);
        closeDropdown();
        currentPage = 0;
        refresh();
      }
    }

    function clearSelection() {
      setSelected([]);
      input.value = '';
      comboEl.classList.remove('has-value');
      closeDropdown();
      currentPage = 0;
      refresh();
    }

    function openDropdown() { renderDropdown(); comboEl.classList.add('open'); }
    function closeDropdown() { comboEl.classList.remove('open'); activeIdx = -1; }

    input.addEventListener('focus', () => { if (!preventBlur && getSelected().length) input.value = ''; openDropdown(); });
    input.addEventListener('blur', () => {
      if (preventBlur) return;
      input.value = displayValue();
      comboEl.classList.toggle('has-value', getSelected().length > 0);
      closeDropdown();
      clearTimeout(shiftTimer);
      currentPage = 0;
      refresh();
    });
    input.addEventListener('input', () => { activeIdx = -1; renderDropdown(); });
    input.addEventListener('keydown', (e) => {
      const items = dropdown.querySelectorAll('.opt');
      if (e.key === 'ArrowDown') { e.preventDefault(); activeIdx = Math.min(activeIdx + 1, items.length - 1); updateActive(items); }
      else if (e.key === 'ArrowUp') { e.preventDefault(); activeIdx = Math.max(activeIdx - 1, 0); updateActive(items); }
      else if (e.key === 'Enter') { e.preventDefault(); if (activeIdx >= 0 && items[activeIdx]) selectOption(items[activeIdx].textContent, e.shiftKey); }
      else if (e.key === 'Escape') input.blur();
    });
    function updateActive(items) { items.forEach((el, i) => el.classList.toggle('active', i === activeIdx)); if (items[activeIdx]) items[activeIdx].scrollIntoView({ block: 'nearest' }); }
    clearBtn.addEventListener('mousedown', (e) => { e.preventDefault(); clearSelection(); });
  }

  // Close all dropdowns when clicking outside
  document.addEventListener('mousedown', (e) => {
    if (!e.target.closest('.combo')) {
      document.querySelectorAll('.combo.open').forEach(c => c.classList.remove('open'));
    }
  });

  // --- Init ---
  async function init() {
    try {
      $('#loading-text').textContent = 'Inicializuojama DuckDB...';

      const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
      const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

      const worker_url = URL.createObjectURL(
        new Blob([`importScripts("${bundle.mainWorker}");`], { type: 'text/javascript' })
      );
      const worker = new Worker(worker_url);
      const logger = new duckdb.VoidLogger();
      db = new duckdb.AsyncDuckDB(logger, worker);
      await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
      URL.revokeObjectURL(worker_url);

      $('#loading-text').textContent = 'Kraunamas Parquet failas...';
      $('#progress-wrap').style.display = 'block';

      const resp = await fetch('vehicles.parquet');
      const contentLength = Number(resp.headers.get('Content-Length') || 0);
      const reader = resp.body.getReader();
      const chunks = [];
      let received = 0;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        chunks.push(value);
        received += value.length;
        if (contentLength) {
          const pct = Math.round((received / contentLength) * 100);
          $('#progress-bar').style.width = pct + '%';
          $('#progress-text').textContent = `${(received / 1048576).toFixed(1)} / ${(contentLength / 1048576).toFixed(1)} MB (${pct}%)`;
        } else {
          $('#progress-text').textContent = `${(received / 1048576).toFixed(1)} MB`;
        }
      }

      const buf = new Uint8Array(received);
      let pos = 0;
      for (const chunk of chunks) {
        buf.set(chunk, pos);
        pos += chunk.length;
      }
      await db.registerFileBuffer('vehicles.parquet', buf);

      $('#progress-wrap').style.display = 'none';
      $('#progress-text').textContent = '';

      conn = await db.connect();
      await conn.query(`CREATE VIEW vehicles AS SELECT * FROM 'vehicles.parquet'`);

      // Get all column names for detail view
      const colResult = await conn.query(`SELECT column_name FROM information_schema.columns WHERE table_name = 'vehicles' ORDER BY ordinal_position`);
      allColumns = colResult.toArray().map(r => r.column_name);

      $('#loading').style.display = 'none';
      $('#app').style.display = 'block';

      // Setup combo boxes
      for (const f of ALL_COMBO_FILTERS) {
        setupCombo($('#' + f.id), f.id);
      }

      // Setup numeric filter inputs with debounce
      for (const f of NUMERIC_FILTERS) {
        let timer;
        $('#' + f.id).addEventListener('input', () => {
          clearTimeout(timer);
          timer = setTimeout(() => { currentPage = 0; refresh(); }, 400);
        });
      }

      // Clear all filters
      $('#clear-filters').addEventListener('click', () => {
        for (const f of ALL_COMBO_FILTERS) {
          filterState[f.id].selectedValues = [];
          const comboEl = $('#' + f.id);
          comboEl.querySelector('input').value = '';
          comboEl.classList.remove('has-value');
        }
        for (const f of NUMERIC_FILTERS) {
          $('#' + f.id).value = '';
        }
        currentPage = 0;
        refresh();
      });

      // Toggle extra filters
      $('#more-toggle').addEventListener('click', () => {
        const extra = $('#extra-filters');
        const open = extra.classList.toggle('open');
        $('#more-toggle').innerHTML = open ? 'Mažiau filtrų &#9652;' : 'Daugiau filtrų &#9662;';
      });

      $('#btn-prev').addEventListener('click', () => { currentPage--; queryResults(); });
      $('#btn-next').addEventListener('click', () => { currentPage++; queryResults(); });

      // Column sorting
      for (const th of $('#thead-row').children) {
        th.addEventListener('click', () => {
          const col = th.dataset.col;
          if (sortCol === col) {
            sortDir = sortDir === 'ASC' ? 'DESC' : 'ASC';
          } else {
            sortCol = col;
            sortDir = 'ASC';
          }
          updateSortArrows();
          currentPage = 0;
          queryResults();
        });
      }

      // Modal close handlers
      $('#modal-close').addEventListener('click', closeModal);
      $('#modal').addEventListener('click', (e) => { if (e.target === $('#modal')) closeModal(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

      await refresh();
    } catch (err) {
      $('#loading-text').textContent = 'Klaida: ' + err.message;
    }
  }

  function parseNumericCondition(col, raw) {
    const s = raw.trim();
    if (!s) return null;
    const m = s.match(/^(>=|<=|>|<|=)?\s*(\d+)$/);
    if (!m) return null;
    const op = m[1] || '=';
    const num = m[2];
    return `CAST("${col}" AS INTEGER) ${op} ${num}`;
  }

  function buildWhereForFilter(f) {
    const val = filterState[f.id].selectedValues;
    if (val.length === 0) return null;
    if (val.length === 1) return `"${f.col}" = '${val[0].replace(/'/g, "''")}'`;
    const list = val.map(v => `'${v.replace(/'/g, "''")}'`).join(', ');
    return `"${f.col}" IN (${list})`;
  }

  function buildWhere() {
    const conditions = [];
    for (const f of ALL_COMBO_FILTERS) {
      const cond = buildWhereForFilter(f);
      if (cond) conditions.push(cond);
    }
    for (const f of NUMERIC_FILTERS) {
      const cond = parseNumericCondition(f.col, $('#' + f.id).value);
      if (cond) conditions.push(cond);
    }
    return conditions.length ? 'WHERE ' + conditions.join(' AND ') : '';
  }

  let refreshId = 0;

  async function refresh() {
    const id = ++refreshId;
    $('#app').classList.add('querying');
    // Yield to browser so spinner renders before heavy queries
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
    if (id !== refreshId) return; // superseded by newer refresh

    const t0 = performance.now();

    await populateFilterOptions();
    if (id !== refreshId) return;
    await queryCount();
    if (id !== refreshId) return;
    await queryResults();

    const elapsed = ((performance.now() - t0) / 1000).toFixed(2);
    $('#query-time').textContent = `${elapsed}s`;
    $('#app').classList.remove('querying');
  }

  async function populateFilterOptions() {
    // Cascading main filters
    for (let i = 0; i < FILTERS.length; i++) {
      const f = FILTERS[i];
      const state = filterState[f.id];

      const conditions = [];
      for (let j = 0; j < i; j++) {
        const above = FILTERS[j];
        const cond = buildWhereForFilter(above);
        if (cond) conditions.push(cond);
      }
      const where = conditions.length ? 'WHERE ' + conditions.join(' AND ') : '';

      const result = await conn.query(
        `SELECT DISTINCT "${f.col}" AS v FROM vehicles ${where} ORDER BY v`
      );
      const rows = result.toArray();

      const options = [];
      for (const row of rows) {
        const v = row.v;
        if (v != null && v !== '') options.push(v);
      }
      state.allOptions = options;

      const valid = state.selectedValues.filter(v => options.includes(v));
      if (valid.length !== state.selectedValues.length) {
        state.selectedValues = valid;
        const comboEl = $('#' + f.id);
        const inp = comboEl.querySelector('input');
        if (valid.length === 0) { inp.value = ''; }
        else if (valid.length === 1) { inp.value = valid[0]; }
        else { inp.value = valid[0] + ' +' + (valid.length - 1); }
        comboEl.classList.toggle('has-value', valid.length > 0);
      }
    }

    // Extra combo filters use the full current WHERE
    for (const f of EXTRA_COMBO_FILTERS) {
      const state = filterState[f.id];
      const where = buildWhere();

      const result = await conn.query(
        `SELECT DISTINCT "${f.col}" AS v FROM vehicles ${where} ORDER BY v`
      );
      const rows = result.toArray();

      const options = [];
      for (const row of rows) {
        const v = row.v;
        if (v != null && v !== '') options.push(v);
      }
      state.allOptions = options;

      const valid = state.selectedValues.filter(v => options.includes(v));
      if (valid.length !== state.selectedValues.length) {
        state.selectedValues = valid;
        const comboEl = $('#' + f.id);
        const inp = comboEl.querySelector('input');
        if (valid.length === 0) { inp.value = ''; }
        else if (valid.length === 1) { inp.value = valid[0]; }
        else { inp.value = valid[0] + ' +' + (valid.length - 1); }
        comboEl.classList.toggle('has-value', valid.length > 0);
      }
    }
  }

  async function queryCount() {
    const where = buildWhere();
    const result = await conn.query(`SELECT COUNT(*) AS c FROM vehicles ${where}`);
    totalRows = Number(result.toArray()[0].c);
    const totalPages = Math.max(1, Math.ceil(totalRows / PAGE_SIZE));
    if (currentPage >= totalPages) currentPage = totalPages - 1;
    $('#count').textContent = `Rasta: ${totalRows.toLocaleString('lt-LT')} įrašų`;
  }

  function updateSortArrows() {
    for (const th of $('#thead-row').children) {
      const existing = th.querySelector('.sort-arrow');
      if (existing) existing.remove();
      if (th.dataset.col === sortCol) {
        const arrow = document.createElement('span');
        arrow.className = 'sort-arrow';
        arrow.textContent = sortDir === 'ASC' ? '\u25B2' : '\u25BC';
        th.appendChild(arrow);
      }
    }
  }

  async function queryResults() {
    const where = buildWhere();
    const orderBy = sortCol ? `ORDER BY "${sortCol}" ${sortDir}` : '';
    const offset = currentPage * PAGE_SIZE;
    const result = await conn.query(
      `SELECT * FROM vehicles ${where} ${orderBy} LIMIT ${PAGE_SIZE} OFFSET ${offset}`
    );
    const rows = result.toArray();
    lastResultRows = rows;

    const tbody = $('#tbody');
    tbody.innerHTML = '';
    rows.forEach((row, idx) => {
      const tr = document.createElement('tr');
      for (const col of DISPLAY_COLS) {
        const td = document.createElement('td');
        const v = row[col];
        td.textContent = v != null ? v : '';
        tr.appendChild(td);
      }
      tr.addEventListener('click', () => showDetail(idx));
      tbody.appendChild(tr);
    });

    const totalPages = Math.max(1, Math.ceil(totalRows / PAGE_SIZE));
    $('#page-info').textContent = `${currentPage + 1} / ${totalPages}`;
    $('#btn-prev').disabled = currentPage <= 0;
    $('#btn-next').disabled = currentPage >= totalPages - 1;
  }

  function showDetail(idx) {
    const row = lastResultRows[idx];
    if (!row) return;

    const marke = row.AGR_MARKE || '';
    const model = row.KOMERCINIS_PAV || '';
    $('#modal-title').textContent = [marke, model].filter(Boolean).join(' ') || 'Informacija';

    const tbody = $('#modal-body');
    tbody.innerHTML = '';
    for (const col of allColumns) {
      const tr = document.createElement('tr');
      const th = document.createElement('th');
      th.textContent = col;
      const td = document.createElement('td');
      const v = row[col];
      td.textContent = v != null ? v : '';
      tr.appendChild(th);
      tr.appendChild(td);
      tbody.appendChild(tr);
    }

    $('#modal').classList.add('open');
  }

  function closeModal() {
    $('#modal').classList.remove('open');
  }

  init();
</script>

</body>
</html>
